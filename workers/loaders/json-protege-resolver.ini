append = pack

# load some plugins to activate some statements
[use]
plugin = basics
plugin = analytics

# Toggle ezs traces (see server stderr log)
[debug]
ezs = false

[exploding]
[combine]
path = value.@id
primer = env('bufferID')
prepend = buffers

[combine/replace]
path = id
value = get('@id')
path = value
value = self().omit('bufferID')

[replace]
path = id
value = get('id')
path = value
value = get('value.@id.value').mapValues((o) => Array.isArray(o) && o.length === 1 ? o.pop() : o)

[aggregate]

# Ensures that each object contains an identification key (required by lodex)
[swing]
test = pick(['URI', 'uri']).pickBy(_.identity).isEmpty()
[swing/identify]

# Prevent keys from containing dot path notation (which is forbidden by nodejs mongoDB driver)
[OBJFlatten]
separator = fix('.')
reverse = true
safe = true

# Uncomment to see each data sent to the database
#[debug]

# Add contextual metadata related to the import
[assign]
path = lodexStamp.importedDate
value = fix(new Date()).thru(d => d.toDateString())
path = lodexStamp.usedParser
value = env('parser')
path = lodexStamp.uploadedFilename
value = env('source')
path = uri
value = get('uri').trim()

